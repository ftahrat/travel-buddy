<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Student Travel Connections</title>
<style>
  body{font-family:'Poppins',Arial,sans-serif;background:linear-gradient(to right,#ffe6f0,#e6f7ff);text-align:center;padding:20px}
  h1{color:#ff3366;margin-bottom:20px}
  form,.match-section{background:#ffffffcc;padding:25px;border-radius:15px;display:inline-block;margin-bottom:20px;box-shadow:0 8px 16px rgba(0,0,0,0.2)}
  input,select,button{display:block;margin:12px auto;padding:12px;width:80%;border-radius:8px;border:1px solid #ccc;font-size:16px}
  button{background:linear-gradient(to right,#ff6699,#ff3366);color:#fff;border:none;cursor:pointer;transition:all .25s}
  button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
  #matches{margin-top:20px;font-weight:600;color:#333;word-break:break-word;max-height:400px;overflow-y:auto;padding:10px;background:#fff3f6;border-radius:10px;text-align:left}
  #matches li{margin:12px 0;padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .group-meta{font-size:0.95rem;color:#666;margin-bottom:6px}
  .join-link{display:inline-block;margin-top:8px;padding:8px 12px;background:#0077ff;color:#fff;border-radius:6px;text-decoration:none}
  .small{font-size:0.9rem;color:#666}
</style>
</head>
<body>

<h1>Student Travel Connections</h1>

<form id="travelForm">
  <input id="name" type="text" placeholder="Your Name" required />
  <input id="email" type="email" placeholder="Your Email" required />
  <label for="destination">Choose your destination:</label>
  <select id="destination" required>
    <option value="">--Select a destination--</option>
    <option>Austria</option><option>Belgium</option><option>Croatia</option><option>Cyprus</option>
    <option>Czech Republic</option><option>Denmark</option><option>Finland</option><option>France</option>
    <option>Germany</option><option>Greece</option><option>Iceland</option><option>Ireland</option>
    <option>Italy</option><option>Luxembourg</option><option>Montenegro</option><option>Malta</option>
    <option>Albania</option><option>Netherlands</option><option>Norway</option><option>Poland</option>
    <option>Portugal</option><option>Romania</option><option>Serbia</option><option>Spain</option>
    <option>Sweden</option><option>Switzerland</option><option>Turkey</option><option>Georgia</option>
    <option>London</option>
  </select>

  <select id="londonTrips" style="display:none;">
    <option value="">--Select a day trip--</option>
    <option>Stonehenge</option><option>Cambridge</option><option>Oxford</option>
    <option>Bath</option><option>Brighton</option><option>Windsor</option>
  </select>

  <button type="submit">Join Travel Pool</button>
  <div class="small" style="margin-top:8px">Tip: fill destination & join — groups form automatically when 2+ people pick the same place.</div>
</form>

<div class="match-section" style="vertical-align:top">
  <label for="matchDestination">Select destination to see groups:</label>
  <select id="matchDestination">
    <option value="">--All destinations--</option>
    <option>Austria</option><option>Belgium</option><option>Croatia</option><option>Cyprus</option>
    <option>Czech Republic</option><option>Denmark</option><option>Finland</option><option>France</option>
    <option>Germany</option><option>Greece</option><option>Iceland</option><option>Ireland</option>
    <option>Italy</option><option>Luxembourg</option><option>Montenegro</option><option>Malta</option>
    <option>Albania</option><option>Netherlands</option><option>Norway</option><option>Poland</option>
    <option>Portugal</option><option>Romania</option><option>Serbia</option><option>Spain</option>
    <option>Sweden</option><option>Switzerland</option><option>Turkey</option><option>Georgia</option>
    <option>London</option>
  </select>
  <button id="showBtn">Show Groups</button>
</div>

<ul id="matches"><li class="small">No groups loaded yet — click "Show Groups".</li></ul>

<script>
  // ====== CONFIG - put your Apps Script /exec URL here ======
  const scriptURL = 'SCRIPT_URL'; // <-- replace with your full /exec URL (must be HTTPS and public)

  // Basic form submit (POST)
  document.getElementById('travelForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const destination = document.getElementById('destination').value.trim();
    const dayTrip = document.getElementById('londonTrips').value.trim();

    if (!scriptURL || scriptURL === 'SCRIPT_URL') {
      alert('Please set scriptURL in the code to your Apps Script /exec URL.');
      return;
    }

    const fd = new FormData();
    fd.append('name', name);
    fd.append('email', email);
    fd.append('destination', destination);
    fd.append('dayTrip', dayTrip);

    try {
      const res = await fetch(scriptURL, { method: 'POST', body: fd });
      if (!res.ok) throw new Error('Network response not ok: ' + res.status);
      alert('You have joined the travel pool!');
      this.reset();
      document.getElementById('londonTrips').style.display = 'none';
    } catch (err) {
      console.error('Submit error:', err);
      alert('Error submitting — check console for details.');
    }
  });

  // Show London day trips only when London selected
  document.getElementById('destination').addEventListener('change', function () {
    document.getElementById('londonTrips').style.display = this.value === 'London' ? 'block' : 'none';
  });

  // Utility: build groups if backend returns flat array
  function buildGroupsFromArray(arr) {
    const groups = {};
    arr.forEach(item => {
      // allow both dayTrip and daytrip casing
      const day = item.dayTrip || item.daytrip || '';
      const key = (item.destination === 'London' && day) ? `${item.destination} - ${day}` : (item.destination || 'Unknown');
      if (!groups[key]) groups[key] = { students: [], groupLink: item.groupLink || '' };
      groups[key].students.push({ name: item.name || '(no name)', email: item.email || '', dayTrip: day });
    });
    return groups;
  }

  // Render groups object: { "France": [{...}, ...], "London - Stonehenge": [...] } or our shaped object
  function renderGroups(groupsObj) {
    const matches = document.getElementById('matches');
    matches.innerHTML = '';
    const keys = Object.keys(groupsObj);

    if (keys.length === 0) {
      matches.innerHTML = '<li>No groups found.</li>';
      return;
    }

    keys.forEach(key => {
      // groupsObj may be either: groupsObj[key] = array OR { students: [...], link: '...' }
      let group = groupsObj[key];
      let students = [];
      let link = '';

      if (Array.isArray(group)) {
        students = group;
        link = (group[0] && group[0].groupLink) ? group[0].groupLink : '';
      } else if (group && group.students) {
        students = group.students;
        link = group.groupLink || '';
      } else {
        // fallback: try to handle if group is object of persons
        students = Array.isArray(group) ? group : [];
        link = group.groupLink || '';
      }

      const li = document.createElement('li');

      // header
      const header = document.createElement('div');
      header.innerHTML = `<strong>${key}</strong> <span class="group-meta">(${students.length} student${students.length !== 1 ? 's' : ''})</span>`;
      li.appendChild(header);

      // list of students (only show names + first 2 chars of email to avoid showing full emails if you prefer)
      const namesHtml = students.map(s => {
        const safeEmail = s.email ? ` — ${s.email}` : '';
        return `<div>${(s.name || '(no name)')}${safeEmail}</div>`;
      }).join('');
      const namesWrap = document.createElement('div');
      namesWrap.style.marginTop = '6px';
      namesWrap.innerHTML = namesHtml;
      li.appendChild(namesWrap);

      // join link if provided and group has >=2 people
      if (students.length >= 2) {
        if (link) {
          const a = document.createElement('a');
          a.href = link;
          a.target = '_blank';
          a.className = 'join-link';
          a.textContent = 'Join Group Chat';
          li.appendChild(a);
        } else {
          const hint = document.createElement('div');
          hint.className = 'small';
          hint.style.marginTop = '8px';
          hint.textContent = 'Group exists (≥2 people) — no chat link set yet.';
          li.appendChild(hint);
        }
      } else {
        const hint = document.createElement('div');
        hint.className = 'small';
        hint.style.marginTop = '8px';
        hint.textContent = 'Waiting for more students (needs 2+ to form a group).';
        li.appendChild(hint);
      }

      matches.appendChild(li);
    });
  }

  // Show groups (button)
  document.getElementById('showBtn').addEventListener('click', async function () {
    if (!scriptURL || scriptURL === 'SCRIPT_URL') {
      alert('Please set scriptURL in the code to your Apps Script /exec URL.');
      return;
    }

    const selectedDestination = document.getElementById('matchDestination').value;
    let url = scriptURL;
    if (selectedDestination) url += `?destination=${encodeURIComponent(selectedDestination)}`;

    try {
      console.log('Fetching groups from:', url);
      const res = await fetch(url);
      console.log('Response status:', res.status, res.statusText);

      // read raw text so we can debug JSON parse issues
      const raw = await res.text();
      console.log('Raw response text:', raw.slice(0, 2000)); // truncate long output
      let data;
      try {
        data = JSON.parse(raw);
      } catch (jsonErr) {
        console.error('Failed to parse JSON:', jsonErr);
        document.getElementById('matches').innerHTML = `<li>Server returned invalid JSON. Check Apps Script console and redeploy. See browser console for details.</li>`;
        return;
      }

      // Accept either: object-map-of-groups OR flat array-of-rows
      let groupsObj = {};
      if (Array.isArray(data)) {
        // backend returned flat rows => convert to grouped object
        groupsObj = buildGroupsFromArray(data);
      } else if (typeof data === 'object' && data !== null) {
        // If backend already returned grouped object, accept it
        // But normalize if the backend returns groups[key] = array (common)
        // Or groups[key] = { students: [...], groupLink: '...' }
        // we'll detect and pass through
        // If data looks like { "0": {...} } it's still an object - convert to array grouping
        const looksLikeGroups = Object.values(data).every(v => Array.isArray(v) || (v && v.students));
        if (looksLikeGroups) {
          groupsObj = data;
        } else {
          // maybe it's a flat object entry; try converting
          // (fallback) convert into one-group with key "Results"
          groupsObj = buildGroupsFromArray([data]);
        }
      } else {
        document.getElementById('matches').innerHTML = `<li>Unexpected response shape from server.</li>`;
        console.error('Unexpected data type:', typeof data, data);
        return;
      }

      // render
      renderGroups(groupsObj);

    } catch (err) {
      console.error('Fetch / show groups error:', err);
      alert('Could not load groups. Open the browser console (Inspect → Console) for details.');
    }
  });

  // Quick test helper you can run in console:
  // fetch(scriptURL).then(r=>r.text()).then(t=>console.log(t)).catch(e=>console.error(e));
</script>

</body>
</html>
